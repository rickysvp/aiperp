## 系统架构设计

### 1. 开发者大钱包（Faucet Wallet）
- 维护充足的 MON 和 MockUSDT
- 负责给新用户发放试玩资金
- 存储在服务端环境变量

### 2. 试玩账号生成流程

```
用户点击"试玩" → POST /api/generate-test-wallet
                    ↓
            生成新私钥+地址（ethers.js）
                    ↓
            大钱包转账 0.02 MON + 1000 USDT
                    ↓
            返回 { address, privateKey }
                    ↓
            前端存入 localStorage
                    ↓
            注入 wagmi 作为 custom signer
```

### 3. 技术实现方案

#### A. 后端 API (Next.js API Routes)
```typescript
// pages/api/generate-test-wallet.ts
export default async function handler(req, res) {
  // 1. 生成新钱包
  const wallet = ethers.Wallet.createRandom();
  
  // 2. 大钱包转账
  const faucetWallet = new ethers.Wallet(FAUCET_PRIVATE_KEY, provider);
  await faucetWallet.sendTransaction({ to: wallet.address, value: "0.02" });
  await usdtContract.connect(faucetWallet).transfer(wallet.address, 1000e6);
  
  // 3. 返回地址和私钥
  res.json({ address: wallet.address, privateKey: wallet.privateKey });
}
```

#### B. 前端 Custom Signer 注入
```typescript
// 创建试玩钱包的 signer
const testWallet = new ethers.Wallet(privateKey, provider);

// 注入 wagmi
const customConnector = createCustomConnector({
  signer: testWallet,
  address: testWallet.address
});
```

#### C. Agent 独立钱包
每个 Agent NFT 对应一个独立钱包地址：
- 铸造时生成新私钥
- 用户存款 = 从用户钱包转到 Agent 钱包
- Agent 参与博弈使用自己的钱包签名

### 4. 数据流

```
用户试玩钱包
    ↓ (铸造 Agent)
Agent 独立钱包 ← 用户存入 USDT
    ↓ (部署到竞技场)
Arena 合约 ← Agent 钱包调用 deposit/chooseFaction
    ↓ (博弈)
结算 → Agent 钱包余额变化
    ↓ (Withdraw)
用户可提取到试玩钱包
```

### 5. 关键修改点

1. **新增 API 路由**
   - `/api/generate-test-wallet` - 生成试玩账号
   - `/api/faucet` - 领水接口

2. **新增 WalletContext 模式**
   - `normal` - 正常 MetaMask 连接
   - `test` - 试玩钱包（localStorage 存储私钥）

3. **Agent 钱包管理**
   - 每个 Agent 生成独立私钥
   - 存储在 localStorage: `agent-wallet-{agentId}`
   - 铸造时自动创建并转账

4. **合约交互调整**
   - 铸造 Agent 时传入初始存款金额
   - 合约自动将 USDT 从用户转到 Agent 钱包

### 6. 安全考虑

- 试玩钱包私钥仅存在用户 localStorage
- 服务端不存储任何私钥
- 试玩资金有限（1000 USDT上限）
- 可设置试玩账号有效期

### 7. 实施步骤

1. 创建后端 API 路由
2. 修改 WalletContext 支持试玩模式
3. 添加试玩钱包生成 UI
4. 修改 Agent 铸造流程（创建独立钱包）
5. 测试完整流程

需要我开始实施吗？