# 全站数据逻辑系统性优化方案

## 📋 问题诊断

经过全面代码审查，发现以下核心问题：

### 1. **数据源不统一**

* `App.tsx` 同时使用本地状态和 `useSupabaseAgents` hook，但 hook 未被正确使用

* 存在两套数据管理逻辑，导致数据不一致

### 2. **Agent 数据同步缺失**

* 游戏循环中修改 Agent PnL 只更新本地状态

* `handleDeployAgent` 和 `handleWithdrawAgent` 仅修改本地，未同步 Supabase

* 缺少实时 PnL 同步机制

### 3. **钱包数据同步问题**

* `WalletContext` 的更新函数先改本地再异步同步 Supabase

* 网络失败时导致数据不一致

### 4. **市场数据同步不可靠**

* 游戏循环中只有 3% 概率同步市场数据

* 市场数据初始化和加载逻辑不完整

### 5. **PnL 历史记录逻辑混乱**

* 记录频率随机且不可控

* 未与 Supabase 正确集成

***

## 🎯 优化方案

### 阶段一：统一数据源架构

1. **重构 App.tsx** - 完全移除本地 Agent 状态管理
2. **统一使用** **`useSupabaseAgents`** - 作为唯一数据源
3. **优化 hook 功能** - 增强 PnL 更新、部署、提现等操作

### 阶段二：完善 Agent 数据同步

1. **游戏循环 PnL 同步** - 每 tick 更新后立即同步到 Supabase
2. **部署/提现逻辑** - 完全使用 API 函数，确保数据一致性
3. **PnL 历史记录** - 建立规律的记录机制

### 阶段三：优化 Wallet 数据同步

1. **原子化更新** - 确保 Supabase 更新成功后再更新本地
2. **错误处理** - 添加失败重试和回滚机制

### 阶段四：完善市场数据

1. **可靠同步机制** - 确保市场数据持续同步
2. **初始化加载** - 从 Supabase 加载历史市场数据

### 阶段五：清理和测试

1. **移除冗余代码** - 删除未使用的本地状态
2. **完整测试** - 验证所有业务流程数据一致性

***

## 📝 具体文件修改清单

1. **`App.tsx`** - 核心重构，统一数据源
2. **`hooks/useSupabaseAgents.ts`** - 增强功能
3. **`lib/api/agents.ts`** - 完善 API 函数
4. **`contexts/WalletContext.tsx`** - 优化同步逻辑
5. **`lib/api/market.ts`** - 完善市场数据 API
6. **所有组件** - 确保使用统一数据源

